<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks</title>
    <link rel="stylesheet" href="static/tasks.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        th, td {
            border: 1px solid #9e7c5a;
            padding: 8px;
            text-align: center;
            height:40px;
        }
        h1{
            color: #8b6239;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black background */
            font-family: 'Times New Roman', Times, serif;
        }

        .modal-content {
            background-color: #f7efe3; /* Light brown modal background */
            margin: 10% auto;
            border: 1px solid #b68f69; /* Dark brown border */
            width: 80%;
        }


        .modal-title{
            padding-top:20px;
            padding-left:20px;
        }
        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 10px 0;
            text-align: center;
        }

        /* Button styles */
        .btn {
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .btn:hover {
            color: white;
        }
        .modal .btn:active {
            color: white;
        }
        .cancel{
            padding:7px 10px;
            border:1px solid #b68f69;
        }
        @media (max-width: 400px){
            .btn{
                padding:5px;
            }
            button{
                padding:1px;
            }
        }
    </style>
</head>
<body>

    <!-- header -->
    <div class="headingsec">
        <header class="header">
            <img src="https://i.postimg.cc/zGd75hDL/download-1-removebg-preview.png" width="55px" height="45px" class="logo">
            <a href="/welcome" class="homelink">TASKIFY</a>
        </header>
    </div>

    <div class="main">

        <!-- Update Task Modal -->
        <div id="updateModal" class="modal">
            <div class="modal-dialog modal-dialog-centered md-scrollable md-large">
                <div class="modal-content">
                    <!-- Modal Header (Title) -->
                    <div class="modal-header"  style="border-bottom: 1px solid #b68f69;">
                        <h2 class="modal-title">Update your task</h2>
                    </div>
                    <!-- Modal Body -->
                    <div class="modal-body"  style="border-bottom: 1px solid #b68f69;">
                        <form id="updateForm" action="/update" method="post">
                            <input type="hidden" id="updateId" name="updateId">
                            <label for="updateNameInput">New Task Name:</label>
                            <input type="text" id="updateNameInput" name="name" placeholder="New Task Name" autocomplete="off">
                            <br><br>
                            <label for="updateStartTimeInput">New Start Time:</label>
                            <input type="datetime-local" id="updateStartTimeInput" name="start_time" required>
                            <br><br>
                            <label for="updateEndTimeInput">New End Time:</label>
                            <input type="datetime-local" id="updateEndTimeInput" name="end_time" required>
                        </form>
                    </div>
                    <!-- Modal Footer -->
                    <div class="modal-footer">
                        <button type="button" class="cancel" onclick="closeModal()">Cancel</button>
                            <form id="updateForm" action="/update" method="post">
                                <button type="submit" class="btn btn-success save">Save Changes</button>
                            </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Delete Confirmation-->
        <div id="deleteModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered md-scrollable md-large" role="document">
                <div class="modal-content">
                    <h2 class="modal-title" style="border-bottom: 1px solid #b68f69;">Confirmation</h2>
                    <div class="modal-body" style="border-bottom: 1px solid #b68f69;">
                        <p>Are you sure you want to delete this Task?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel" onclick="closeDelModal()">Cancel</button>
                        <form id="deleteForm" action="/delete_task" method="POST">
                            <input type="hidden" id="deleteId" name="deleteId">
                            <button type="submit" class="btn btn-danger">Yes, I'm Sure</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <h1>Organize your tasks</h1>

        <br>
        <div class="page-container">

            <table>
                <thead>
                    <tr>
                        <th>Task ID</th>
                        <th>Task Name</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Task Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Python code to populate tasks -->
                    {% for task in tasks %}
                    <tr class="task-row" data-start-time="{{ task.start_time }}">
                        <td>{{ loop.index }}</td> 
                        <td>{{ task.task_name }}</td>
                        <td>Date:{{ task.start_time.split('T')[0] }} <br>Time:{{ task.start_time.split('T')[1] }}</td>
                        <td>Date:{{ task.end_time.split('T')[0] }} <br>Time:{{ task.end_time.split('T')[1] }}</td>
                        <td>{{ 'Completed' if task.task_status == 1 else 'pending' }}</td>
                        <td>
                            <!-- Button to Trigger Delete Modal -->
                            <button class="btn btn-danger" onclick="openDeleteModal({{ task.id }})" data-bs-target="#deleteModal" data-bs-toggle="modal">Delete</button>
                                    
                            <!-- Button to Open Update Task Modal -->
                            <button type="button" onclick="openUpdateModal({{ task.id }}, '{{ task.task_name }}', '{{ task.start_time }}', '{{ task.end_time }}')" class="btn btn-warning" data-bs-target="#updateModal" data-bs-toggle="modal">Update</button>
        
        
                            {% if task.task_status == 0 %}
                                <button class="btn btn-success" onclick="completeTask({{ task.id }})">Completed</button>
                            {% endif %}
                            {% if task.task_status == 1 %}
                                <button class="btn btn-primary" onclick="redo({{ task.id }})">Do it again</button>
                            {% endif %}
        
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>        
        <br>

        <a href="/welcome" class="btnn">Back to Dashboard <i class="fa-solid fa-circle-chevron-left"></i></a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/2.0.2/luxon.min.js"></script>

    <script>

        
        function openDeleteModal(id) {
            document.getElementById('deleteId').value = id; // Set the deleteId in the form
            document.getElementById('deleteModal').style.display = 'block';
        }
        
        function closeDelModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }   
        // Optional: You can remove the close button functionality if not needed
        document.querySelector('.close').addEventListener('click', closeDelModal);
        
        // Optional: You can also add an event listener to close the modal on Escape key press
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeDelModal();
            }
        });
    

        function openUpdateModal(id, name, startTime, endTime) {
            document.getElementById('updateId').value = id;
            document.getElementById('updateNameInput').value = name;
            document.getElementById('updateStartTimeInput').value = startTime;
            document.getElementById('updateEndTimeInput').value = endTime;
            document.getElementById('updateModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('updateModal').style.display = 'none';
        } 

        // Optional: You can also add an event listener to close the modal on Escape key press
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        //press key 't' to exit update modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'r') {
                closeModal();
            }
        });

        async function completeTask(id) {
            const response = await fetch(`/complete/${id}`, { method: 'POST' });
            if (response.ok) {
                // Reload the page after completing the task
                window.location.reload();
            } else {
                // Handle error if necessary
                console.error('Error completing task:', response.statusText);
            }
        }
        async function redo(id) {
            const response = await fetch(`/redo/${id}`, { method: 'POST' });
            if (response.ok) {
                // Reload the page after completing the task
                window.location.reload();
            } else {
                // Handle error if necessary
                console.error('Error re-doing task:', response.statusText);
            }
        }
        

        document.addEventListener('DOMContentLoaded', () => {
            // Check if the browser supports notifications
            if (!('Notification' in window)) {
                console.log('This browser does not support desktop notifications.');
                return;
            }

            // Request permission for notifications
            Notification.requestPermission().then(function (result) {
                console.log('Notification permission:', result);
            });

            // Get tasks data from Flask template
            const tasksData = JSON.parse('{{ tasks | tojson | safe }}');

            // Check tasks for upcoming start times
            tasksData.forEach(task => {
                const startTime = new Date(task.start_time);
                const currentTime = new Date();

                // Calculate time difference in milliseconds
                const timeDiff = startTime.getTime() - currentTime.getTime();

                // If the task starts in less than 5 minutes, show a notification
                if (timeDiff > 0 && timeDiff <= 300000) { // 5 minutes in milliseconds
                    const notification = new Notification('Task Reminder', {
                        body: `Task "${task.task_name}" starts soon!`,
                    });
                }
            });
        });
        
    </script>
</body>
</html>
